<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>証券化マスター</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-black">
  <div id="root" class="mx-auto max-w-3xl px-4 py-5"></div>

  <script>
  const YEARS = [2024, 2023];
  const YEAR_KEY = "securitization-year-v1";

  const LS_KEY = (year)=>`securitization-progress-v1:${year}`;
  const saveState = (y,s)=>localStorage.setItem(LS_KEY(y), JSON.stringify(s));
  const loadState = (y)=>{
    try { return JSON.parse(localStorage.getItem(LS_KEY(y))||"null"); }
    catch { return null; }
  };

  async function tryFetchJson(path){
    try{
      const res = await fetch(path, { cache:"no-store" });
      if(!res.ok) throw new Error(res.status);
      return await res.json();
    }catch{ throw new Error("fetch-failed"); }
  }

  async function loadQuestions(year){
    const data = await tryFetchJson(`/${year}.json`);
    if(!Array.isArray(data) || !data.length) throw new Error("format");
    return data;
  }

  const h = React.createElement;
  function btn(label,onClick,disabled=false){
    const cls="px-4 py-2 border rounded-lg bg-gray-100 hover:bg-gray-200 disabled:opacity-40";
    return h("button",{className:cls,onClick,disabled},label);
  }
  function scrollTop(){ window.scrollTo({top:0,behavior:"smooth"}); }

  function App(){
    const savedYear = Number(localStorage.getItem(YEAR_KEY)) || YEARS[0];
    const [year,setYear]=React.useState(savedYear);
    const [all,setAll]=React.useState(null);
    const [i,setI]=React.useState(0);
    const [k,setK]=React.useState(0);
    const [show,setShow]=React.useState(false);
    const [err,setErr]=React.useState("");

    React.useEffect(()=>{
      localStorage.setItem(YEAR_KEY,year);
      setErr("");setAll(null);setI(0);setK(0);setShow(false);
      loadQuestions(year)
        .then(q=>{setAll(q);})
        .catch(()=>setErr(`/${year}.json が見つかりません`));
    },[year]);

    if(err) return h("div",{className:"p-5 text-red-600"},err);
    if(!all) return h("div",{className:"p-5"},"読み込み中...");

    const q=all[i], c=q.choices[k];

    const yearSel=h("select",{value:year,onChange:e=>setYear(Number(e.target.value)),
      className:"border rounded-lg px-2 py-1 bg-white"},
      YEARS.map(y=>h("option",{key:y,value:y},y))
    );

    function next(){ setShow(false); setK(k+1<q.choices.length?k+1:0);
      if(k+1>=q.choices.length) setI((i+1)%all.length);
      scrollTop();
    }
    function back(){ setShow(false);
      if(k>0) setK(k-1);
      else{const pi=(i-1+all.length)%all.length; setI(pi); setK(all[pi].choices.length-1);}
      scrollTop();
    }
    function judge(ans){ setShow(true); }

    const feedback=show && h("div",{className:"mt-3 border p-3 rounded-xl"},
      h("div",{className:c.isTrue?"text-green-600":"text-red-600"},
        `正解：${c.isTrue?"○（正しい）":"×（誤り）"}`),
      c.explain && h("p",{className:"mt-1 text-sm text-neutral-700"},c.explain),
      btn("次へ",next)
    );

    return h("div",{className:"p-5"},
      h("div",{className:"flex gap-3 mb-4 items-center"},h("span","年度："),yearSel),
      h("div",{className:"text-sm text-neutral-500 mb-2"},`${q.section} / ${i+1}/${all.length}`),
      h("div",{className:"text-[18px] mb-4"},q.stem),
      h("div",{className:"border rounded-2xl p-4"},
        h("div",{className:"text-[18px]"},`${c.id}. ${c.text}`),
        h("div",{className:"flex gap-2 mt-3"},
          btn("○ 正しい",()=>judge(true),show),
          btn("× 誤り",()=>judge(false),show)
        ),
        feedback
      ),
      h("div",{className:"flex gap-2 mt-4"},
        btn("戻る",back),btn("次へ",next)
      )
    );
  }

  ReactDOM.createRoot(document.getElementById("root")).render(h(App));
  </script>
</body>
</html>
